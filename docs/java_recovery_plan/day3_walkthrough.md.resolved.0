# Week 1 Day 3: 例外ハンドリングの統一化

## 完了したDrill

- ✅ **Drill 9**: Custom Exception Class
- ✅ **Drill 10**: Global Exception Handler with @RestControllerAdvice
- ✅ **Drill 11**: Update Service to use Custom Exception

## 実装内容

### 1. カスタム例外クラス (ResourceNotFoundException)

```java
public class ResourceNotFoundException extends RuntimeException {
    public ResourceNotFoundException(String message) {
        super(message);
    }
}
```

**ポイント:**
- `RuntimeException`を継承（非検査例外）
- メッセージを受け取るコンストラクタ

### 2. グローバル例外ハンドラー (GlobalExceptionHandler)

```java
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(ResourceNotFoundException.class)
    public ResponseEntity<ErrorResponse> handleResourceNotFoundException(ResourceNotFoundException ex) {
        ErrorResponse error = new ErrorResponse(ex.getMessage(), 404, LocalDateTime.now());
        return ResponseEntity.status(HttpStatus.NOT_FOUND).body(error);
    }
}

record ErrorResponse(String message, int status, LocalDateTime timestamp) {}
```

**ポイント:**
- `@RestControllerAdvice`: 全コントローラーで共通の例外処理
- `@ExceptionHandler`: 特定の例外をキャッチ
- [ErrorResponse](file:///c:/Users/user/Dev/java-training-ground/exercises/week1-crud-time-attack/src/main/java/com/example/week1/exception/GlobalExceptionHandler.java#31-33): 統一されたエラーレスポンス形式

### 3. Service層での使用

```java
public UserResponse getUser(@NonNull Long id) {
    return repository.findById(id)
            .map(user -> new UserResponse(user.getId(), user.getUsername()))
            .orElseThrow(() -> new ResourceNotFoundException("User not found with id: " + id));
}
```

## 学んだこと

### 1. @RestControllerAdvice の威力

Day 2までは、`RuntimeException`を投げるだけでした。これだと：
- エラーレスポンスがSpringのデフォルト形式
- どこでどんなエラーが起きたか追いにくい
- ステータスコードが500になってしまう

`@RestControllerAdvice`を使うと：
- ✅ 統一されたエラーレスポンス
- ✅ 適切なHTTPステータスコード（404, 400, 500など）
- ✅ コントローラー層に例外処理を書かなくて済む

### 2. カスタム例外の使い分け

| 例外名 | HTTPステータス | 用途 |
|--------|---------------|------|
| [ResourceNotFoundException](file:///c:/Users/user/Dev/java-training-ground/exercises/week1-crud-time-attack/src/main/java/com/example/week1/exception/ResourceNotFoundException.java#9-14) | 404 NOT_FOUND | リソースが見つからない |
| `BadRequestException` | 400 BAD_REQUEST | リクエストが不正 |
| `UnauthorizedException` | 401 UNAUTHORIZED | 認証失敗 |
| `ForbiddenException` | 403 FORBIDDEN | 権限なし |

### 3. エラーレスポンスの統一

Before（Day 2まで）:
```json
{
  "timestamp": "2024-11-24T12:55:00",
  "status": 500,
  "error": "Internal Server Error",
  "path": "/users/999"
}
```

After（Day 3）:
```json
{
  "message": "User not found with id: 999",
  "status": 404,
  "timestamp": "2024-11-24T12:55:00"
}
```

## まとめ

Day 3で学んだパターン:
- ✅ カスタム例外クラスの作成
- ✅ `@RestControllerAdvice`で統一的なエラー処理
- ✅ 適切なHTTPステータスコードの返却
- ✅ Service層での`orElseThrow`パターン

次のステップ：
- **Day 4-5**: CRUD Time Attack（これまでの知識で1時間以内にCRUDアプリを完成させる）
